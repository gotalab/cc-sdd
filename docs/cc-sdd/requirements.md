# cc-sdd 要求仕様（Requirements)

## 目的（Problem & Goal）
- Claude Code で Kiro 風の Spec-Driven Development を素早く導入・更新できる 1 コマンドのスキャフォルダを提供する。
- OS と言語の違いによる毎回の手作業（ファイルコピー、OS別コマンド、言語差し替え）を排除し、安全に上書きできる体験を標準化する。

## スコープ（In Scope）
- 実行コマンドは 1 つ（サブコマンド無し）。初回導入/既存更新を自動判定。
- 出力対象:
  - `.claude/commands/kiro/**`（v1=claude-code。すべてのソースは `templates/agents/claude-code/commands/kiro/` に一元化）
  - `CLAUDE.md`（言語テンプレ適用。ソースは `templates/agents/claude-code/docs/CLAUDE/`）
  - `.cc-sdd.json`（設定の保存。agent/OS/lang など）
- フラグと非対話モード、バックアップ、ドライラン、上書きポリシー。
- OS: `mac` | `windows` | `linux` | `auto`（既定: auto）
- 言語: `ja` | `en` | `zh-TW`（既定: en）

## 非スコープ（Out of Scope / v1では扱わない）
- Claude Code hooks/agents のテンプレ出力（将来拡張を想定）。
- 既存ファイルとのセマンティックマージ（保護ブロック以外の自動マージ）。

## ユーザー体験（UX）
- 1 コマンドで初回/更新を自動判定し、差分プランを提示。
- 既存衝突は既定で対話（prompt）。`--yes` で非対話化。`--overwrite` で方針指定。
- 常にロールバック可能なバックアップを提供（`--backup`）。

## コマンドとフラグ
- 実行: `npx cc-sdd`
- フラグ:
  - `--os <auto|mac|windows|linux>`（既定: auto）
  - `--lang <ja|en|zh-TW>`（既定: ja）
  - `--dry-run`（差分のみ表示。ファイルは変更しない）
  - `--backup[=<dir>]`（上書き前にバックアップ。dir 省略でデフォルトパス）
  - `--overwrite <prompt|skip|force>`（既定: prompt）
  - `--yes|-y`（対話プロンプトを省略）
  - `--agent <claude-code|gemini-cli|qwen-code>`（既定: claude-code。v1 は claude-code のみ適用）
  - `--claude-code` / `--gemini-cli` / `--qwen-code`（`--agent` のエイリアス。相互排他）
  - `--kiro-dir <relative-path>`（Kiro ルートの相対パス。既定: `.kiro`。ネスト可。優先度: CLI > config > default）

### `--yes` と `--overwrite` の関係
- `--yes` のみ → 非対話で安全側（`skip` 相当）にフォールバック。
- `--yes --overwrite force` → 非対話で一括上書き（`--backup` 併用推奨）。
- `--yes --overwrite skip` → 非対話で一括スキップ。

## OS 自動判定（auto）
- Node.js `process.platform` を基準に判定:
  - `darwin` → `mac`
  - `win32` → `windows`
  - `linux` → `linux`（WSL は linux 扱い。`WSL_DISTRO_NAME` や `/proc/version` の `Microsoft` で補助検知）
- 判定不能時は対話選択、非対話なら安全側（`linux` 相当または `skip` 方針）にフォールバック。

## 初回導入 / 既存更新の自動判定（拡張可能設計）
- 目的: 今後対象ファイル/ディレクトリが増えても、コード変更最小で判定・差分作成が拡張できること。
- アプローチ: __アーティファクト・マニフェスト__ ベース。

### アーティファクト・マニフェスト（例: `templates/manifest.json`）
- 役割: 管理対象アーティファクトの一覧と、検出・出力ルールを定義。
- 例:
```json
{
  "version": 1,
  "artifacts": [
    {
      "id": "commands_kiro_spec_status",
      "outputPath": ".claude/commands/kiro/spec-status.md",
      "source": {
        "type": "template",            
        "path": "templates/agents/claude-code/commands/kiro/base/spec-status.tpl.md",
        "placeholders": ["CMD_LIST_SPEC_DIR", "CMD_FIND_ACTIVE_SPECS", "LANG_CODE"]
      },
      "osSnippet": true,                 
      "detectors": [
        { "type": "pathExists", "path": ".claude/commands/kiro/spec-status.md" },
        { "type": "contentIncludes", "path": ".claude/commands/kiro/spec-status.md", "needle": "Generated by cc-sdd" }
      ],
      "apply": { "whenMissing": "create", "whenPresent": "update" }
    },
    {
      "id": "docs_claude_main",
      "outputPath": "CLAUDE.md",
      "source": {
        "type": "templateByLang",
        "baseDir": "templates/agents/claude-code/docs/CLAUDE",
        "pattern": "CLAUDE.{lang}.tpl.md"
      },
      "detectors": [{ "type": "pathExists", "path": "CLAUDE.md" }],
      "apply": { "whenMissing": "create", "whenPresent": "update" }
    }
  ]
}
```
- 拡張性: 新規アーティファクトの追加はマニフェストに追記するだけで対応。

### 自動判定ロジック
- 各アーティファクトに対し `detectors` を評価し、結果から計画（Plan）を作成:
  - `create` / `update` / `skip` / `conflict`
- ルート判定:
  - 全て `missing` → 初回導入相当
  - 一部存在 → 既存更新相当（ファイル単位で操作を割り当て）

## テンプレート／ソース構造（`templates/` 一元化）
- コマンド資産（テンプレ＋静的）: `templates/agents/claude-code/commands/kiro/`
  - `.tpl.md` / `.tpl.json` はレンダリング対象（プレースホルダ例: `{{CMD_LIST_SPEC_DIR}}`, `{{CMD_FIND_ACTIVE_SPECS}}`, `{{LANG_CODE}}`）
  - それ以外の拡張子は静的コピー（例: `.md`, 画像/バイナリ）。必要に応じて `templates/agents/claude-code/commands/kiro/assets/` 配下に配置
- OS スニペット: `templates/snippets/os/{mac|windows|linux}.json`
  - 例: `{"CMD_LIST_SPEC_DIR": "!ls -la {{KIRO_DIR}}/specs/$ARGUMENTS/"}`（mac/linux）
  - 例: `{"CMD_LIST_SPEC_DIR": "!powershell -NoProfile -Command \"Get-ChildItem -Force {{KIRO_DIR}}/specs/$ARGUMENTS | Format-Table -AutoSize\""}`（windows）
- CLAUDE ドキュメント: `templates/agents/claude-code/docs/CLAUDE/CLAUDE.{ja|en|zh-TW}.tpl.md`
 - マニフェスト: `templates/manifest.json`（導入対象の列挙・検出・適用ルール）
- 変数は `{{LANG_CODE}}`, `{{KIRO_DIR}}` を注入（`KIRO_DIR` 既定: `.kiro`）

### 静的アセットの扱い（テンプレに含めるがレンダリング不要）
- 目的: `.claude/commands/**` で配布する全資産（テンプレ不要の Markdown/画像/バイナリ等）も `templates/` に集約し、導入/更新の単一ソースにする。
- 適用ルール:
  - `.tpl.*` 以外はそのままコピー（パスは `templates/agents/claude-code/commands/kiro/` → `.claude/commands/kiro/` に対応）
  - 衝突判定はハッシュ（SHA-256）で実施。差分があれば `update/conflict` として扱う
  - バイナリ等で識別コメントが入れられないものは、`hash` を `.cc-sdd.json` に保存して追跡
- マニフェスト例（静的一括コピーの定義追加）:
```json
{
  "version": 1,
  "artifacts": [
    {
      "id": "commands_kiro_static_all",
      "source": {
        "type": "staticDir",
        "from": "templates/agents/claude-code/commands/kiro",
        "toDir": ".claude/commands/kiro",
        "include": ["**/*", "!**/*.tpl.*"]
      },
      "detectors": [{ "type": "pathExists", "path": ".claude/commands/kiro" }],
      "apply": { "whenMissing": "create", "whenPresent": "update" }
    }
  ]
}
```

## エージェント拡張（将来互換／設計前提）
- __v1__: `agent=claude-code` 固定（デフォルト）。
- __将来__: `--agent <claude-code|gemini-cli|qwen-code>` による切替に対応。
- __マニフェスト条件__: `when.agent` を追加し、アーティファクト適用をフィルタ。
- __出力レイアウト__: エージェントごとにコマンド出力先の構成は異なる前提。`commands/kiro` を前提にしない。
- __テンプレ変数__: `{{AGENT}}`, `{{AGENT_DIR}}`, `{{AGENT_DOC}}`, `{{AGENT_COMMANDS_DIR}}` を予約（v1 では `claude-code`, `.claude`, `CLAUDE.md`, `.claude/commands/kiro`）。
- __レイアウト解決__: `{{AGENT_COMMANDS_DIR}}` はエージェントレイアウトリゾルバで決定。
  - v1 既定マッピング: `claude-code → .claude/commands/kiro`
  - 将来: `.cc-sdd.json` の `agentLayouts[agent].commandsDir` で上書き可能（設計上の拡張点）。
  - 同様に `{{AGENT_DIR}}`/`{{AGENT_DOC}}` も将来マッピングで解決。
  - 既定マッピング（現時点・仮含む）:
    - `claude-code`: `AGENT_COMMANDS_DIR=.claude/commands/kiro`, `AGENT_DIR=.claude`, `AGENT_DOC=CLAUDE.md`
    - `gemini-cli`（仮）: `AGENT_COMMANDS_DIR=.gemini/commands`, `AGENT_DIR=.gemini`, `AGENT_DOC=GEMINI.md`
    - `qwen-code`（仮）: `AGENT_COMMANDS_DIR=.qwen/commands`, `AGENT_DIR=.qwen`, `AGENT_DOC=QWEN.md`

```json
{
  "version": 1,
  "artifacts": [
    {
      "id": "commands_static_all",
      "source": {
        "type": "staticDir",
        "from": "templates/agents/{{AGENT}}/commands",
        "toDir": "{{AGENT_COMMANDS_DIR}}",
        "exclude": ["**/*.tpl.*"]
      },
      "when": { "agent": ["claude-code", "gemini-cli", "qwen-code"] },
      "detectors": [{ "type": "pathExists", "path": "{{AGENT_COMMANDS_DIR}}" }],
      "apply": { "whenMissing": "create", "whenPresent": "update" }
    }
  ]
}
```

## Kiro ルートディレクトリ（kiroDir）
- 既定: `.kiro`
- 変更方法:
  - フラグ: `--kiro-dir <relative-path>`（リポジトリ相対、ネスト可。例: `kiro`, `.work/kiro`）
  - 設定: `.cc-sdd.json` の `kiroDir`
- 優先順位: CLI > config > default
- バリデーション:
  - 相対パスのみ許可（絶対パス/`..` は不可）
  - 使用可能文字: 英数・`._-/`
- ディレクトリが存在しない場合は作成（空で可）
- テンプレ変数 `{{KIRO_DIR}}` をスニペット/テンプレへ注入
- v1: 既存 `.kiro` からの自動移行は非対応（必要なら手動移行）

## 上書きポリシー / バックアップ / ドライラン
- 上書きポリシー（`--overwrite`）:
  - `prompt`（既定）: 衝突ごとに確認
  - `skip`: 既存は維持（新規のみ作成）
  - `force`: 一括上書き（`--backup` 併用推奨）
- `--yes`（非対話）:
  - `prompt` の場合でも、非対話時は安全側（`skip`）にフォールバック
- `--backup[=<dir>]`:
  - 既定: `.cc-sdd.backup/YYYYMMDD-HHmmss/`
  - `force` 上書き時は自動バックアップを強く推奨
- `--dry-run`:
  - 計画（Plan）と差分要約のみを表示。ファイルは変更しない。

## 設定ファイル（`.cc-sdd.json`）
- 例:
```json
{
  "version": 1,
  "agent": "claude-code",
  "os": "auto",
  "resolvedOs": "mac",
  "lang": "ja",
  "kiroDir": ".kiro",
  "overwrite": "prompt",
  "backupDir": ".cc-sdd.backup",
  "templateVersion": "0.1.0",
  "lastAppliedAt": "2025-08-17T02:10:00+09:00"
}
```
- 役割: 次回実行時の既定値として再利用。CI でも再現可能。
- シンプル運用: 手動で編集するのは上記キーのみで十分（`fileHashes` は CLI が自動管理）。
- 優先順位: CLI フラグ > `.cc-sdd.json` > 既定値（`os=auto`, `lang=ja`, `agent=claude-code`, `kiroDir=.kiro`）

## ログ/表示
- 作業計画（Plan）一覧を表形式で表示（CREATE/UPDATE/SKIP/CONFLICT）。
- カラーリング（成功/警告/注意）と、変更ファイルの相対パスを出力。

## 非機能要件
- クロスプラットフォーム（mac/windows/linux）。
- 冪等性（同一設定で何度実行しても同じ状態）。
- 既存保護（`skip` 既定、`force` はバックアップ推奨）。
- 依存はメジャー/安定ライブラリのみ。

## 受け入れ基準（Acceptance Criteria）
- `npx cc-sdd` 実行で、初回/更新を自動判定し、既定動作で安全に適用されること。
- `--dry-run` で差分プランが確認できること。
- `--yes --overwrite force --backup` で非対話一括更新できること。
- OS `auto` が mac/windows/linux で正しく解決されること（WSL は linux 扱い）。
- テンプレは `.tpl.md/.tpl.json`、OS スニペット適用で所定の出力が得られること。
- `.cc-sdd.json` に `agent=os=lang=kiroDir` 等の選択が保存され、次回実行時に既定として機能すること。
