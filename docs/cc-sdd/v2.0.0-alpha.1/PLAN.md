# cc-sdd テンプレート刷新計画

## 背景と目的
- `cc-sdd` 初期セットアップで展開する成果物を拡充し、エージェント用コマンド・プロジェクトメモリ・テンプレート／ルールの 3 系統を統一的に配布できるようにする。
- 既存テンプレートの OS 別ディレクトリや `.tpl.md` 拡張子といった運用上の負債を解消し、保守性を高める。
- `{{KIRO_DIR}}` を含むプレースホルダは従来通り展開しつつ、設定ディレクトリを変更できる柔軟性を維持する。

## 設計方針
- **テンプレート構造整理**
  - `templates/agents/<agent>/commands/` を OS 非依存の単一ディレクトリ構成に統一する。
  - プロジェクトメモリ（例: `CLAUDE.md`）は `.tpl.md` を廃止し、直接 `.md` テンプレートとして管理する。
  - エージェント共通の設定テンプレートは `templates/shared/settings/` にまとめ、`rules/`・`templates/` 以下の階層構造とする。
- **マニフェスト更新**
  - 各エージェントのマニフェストから OS 条件付きアーティファクトを削除し、`commands` を単一の `templateDir` 参照に変更。
  - 共通設定テンプレートを `{{KIRO_DIR}}/settings` に展開する新アーティファクトを追加。
  - `.tpl.*` への依存をなくし、`.md` / `.json` などの実拡張子を前提にした記述へ更新。
- **テンプレート処理ロジック**
  - 既存の `.tpl.*` 変換ロジックは後方互換のため残しつつ、新テンプレートは生拡張子で扱えることを確認。
  - `{{KIRO_DIR}}`・`{{AGENT_COMMANDS_DIR}}` などのプレースホルダ置換が新構造でも問題なく働くことをテストで保証。
- **テストと検証**
  - 主要エージェント（特に `claude-code`）について、期待するファイル群が生成されることをスナップショットまたはフィクスチャで検証。
  - 設定テンプレートの共通化が他エージェントにも影響しないことを確認。

## 実装ステップ（TODO）
- [x] テンプレートディレクトリの再編：`templates/agents/claude-code/commands/os-*` を統合して `.md` ベースにし、`templates/shared/settings/` を新設し、別プロジェクトで準備済みテンプレート群（commands / templates / プロジェクトメモリ）を本リポジトリへ移行して命名規則を揃える。
- [x] マニフェスト（`templates/manifests/*.json`）の更新：新パスへ差し替え、OS 条件を撤廃し、共通設定の `templateDir` を追加し、プロジェクトメモリを `.md` 前提にしつつ CLI フラグ見直し後も正しく展開されることを確認する。
- [x] コード側の調整：マニフェスト処理とテンプレート展開ロジックが新構造に追従するか検証し、必要な変換ルール・パス指定を修正し、`resolveAgentLayout` などディレクトリ解決が想定どおりかを再確認する。
- [x] テスト整備：既存フィクスチャを新テンプレート構造へ更新し、共通設定展開など不足テストを必要に応じて追加する。
- [x] ドキュメント更新：README などを新テンプレート構成と配布内容に合わせて刷新し、CLI の `--os` 非推奨方針や新しい実行例を反映する。
- [x] Codex エージェント対応：`.codex/prompts/` へのコマンド展開テンプレート追加、レイアウト/マニフェスト/CLIフラグ/ドキュメント/テストの全体更新。
- [x] GitHub Copilot 対応：`.github/prompts/` 向けテンプレート、マニフェスト、CLI フラグ、ドキュメント、E2E テスト追加。

## CLI フラグ見直し方針
- `--os` フラグは後方互換のため維持しつつ、OS 別テンプレートが不要になった旨をヘルプや README で説明。必要なら実行時に非推奨警告を追加。
- 今後の拡張に備えて `--profile` など既存のフラグで配布内容を切り替えられることを整理し、OS 指定ではなくプロファイル指定へ誘導する。
- CLI ドキュメント・`--help` メッセージ・公開用 README を更新し、新しい実行例（例: `npx cc-sdd@latest --lang ja`）へ置き換える。

## 懸念点・検討事項
- 共通設定テンプレートの今後の差分需要：個別エージェントで差異が生じる場合に備え、上書きや追加テンプレートを組み合わせる設計余地を残す。
- `.tpl.*` 廃止に伴う後方互換性：既存プロジェクトで旧版テンプレートを期待しているケースに対して、パッケージバージョンアップ時の注意喚起が必要。
- テスト更新コスト：テンプレート出力のスナップショットが多い場合、一括更新のモードを用意するなど、開発作業の手間を抑える工夫を検討。
