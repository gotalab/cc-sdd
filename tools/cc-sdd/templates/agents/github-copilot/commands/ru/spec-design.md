---
description: Создать технический дизайн для спецификации
allowed-tools: Bash, Glob, Grep, LS, Read, Write, Edit, MultiEdit, Update, WebSearch, WebFetch
argument-hint: <имя-функции> [-y]
---

# Генератор технического дизайна

<background_information>
- **Миссия**: Сгенерировать полный документ технического дизайна, который переводит требования (ЧТО) в архитектурный дизайн (КАК)
- **Критерии успеха**:
  - Все требования сопоставлены с техническими компонентами с чёткими интерфейсами
  - Выполнено соответствующее исследование и изучение архитектуры
  - Дизайн согласован с контекстом steering и существующими паттернами
  - Включены визуальные диаграммы для сложных архитектур
</background_information>

<instructions>
## Основная задача
Сгенерировать документ технического дизайна для функции **$1** на основе утверждённых требований.

## Шаги выполнения

### Шаг 1: Загрузить контекст

**Прочитать весь необходимый контекст**:
- `{{KIRO_DIR}}/specs/$1/spec.json`, `requirements.md`, `design.md` (если существует)
- **Весь каталог `{{KIRO_DIR}}/steering/`** для полной памяти проекта
- `{{KIRO_DIR}}/settings/templates/specs/ru/design.md` для структуры документа
- `{{KIRO_DIR}}/settings/rules/design-principles.md` для принципов дизайна
- `{{KIRO_DIR}}/settings/templates/specs/ru/research.md` для структуры лога исследований

**Проверить утверждение требований**:
- Если указан флаг `-y` ($2 == "-y"): Авто-утвердить требования в spec.json
- Иначе: Проверить статус утверждения (остановить если не утверждено, см. Безопасность и Fallback)

### Шаг 2: Исследование и анализ

**Критично: Эта фаза гарантирует, что дизайн основан на полной, точной информации.**

1. **Классифицировать тип функции**:
   - **Новая функция** (greenfield) → Требуется полное исследование
   - **Расширение** (существующая система) → Исследование фокусируется на интеграции
   - **Простое дополнение** (CRUD/UI) → Минимальное исследование или без него
   - **Сложная интеграция** → Требуется комплексный анализ

2. **Выполнить соответствующий процесс исследования**:
   
   **Для сложных/новых функций**:
   - Прочитать и выполнить `{{KIRO_DIR}}/settings/rules/design-discovery-full.md`
   - Провести тщательное исследование с WebSearch/WebFetch:
     - Последние архитектурные паттерны и лучшие практики
     - Верификация внешних зависимостей (API, библиотеки, версии, совместимость)
     - Официальная документация, руководства по миграции, известные проблемы
     - Бенчмарки производительности и соображения безопасности
   
   **Для расширений**:
   - Прочитать и выполнить `{{KIRO_DIR}}/settings/rules/design-discovery-light.md`
   - Фокус на точках интеграции, существующих паттернах, совместимости
   - Использовать Grep для анализа паттернов существующей кодовой базы
   
   **Для простых дополнений**:
   - Пропустить формальное исследование, только быстрая проверка паттернов

3. **Сохранить результаты исследования для Шага 3**:
- Контракты и ограничения внешних API
- Технологические решения с обоснованием
- Существующие паттерны для следования или расширения
- Точки интеграции и зависимости
- Выявленные риски и стратегии митигации
- Потенциальные архитектурные паттерны и варианты границ (детали в `research.md`)
- Соображения о параллелизации для будущих задач (фиксировать зависимости в `research.md`)

4. **Сохранить результаты в лог исследований**:
- Создать или обновить `{{KIRO_DIR}}/specs/$1/research.md` используя общий шаблон
- Резюмировать объём исследования и ключевые находки (секция Summary)
- Записать исследования в темы Research Log с источниками и последствиями
- Документировать оценку архитектурных паттернов, решения по дизайну и риски используя секции шаблона
- Использовать язык, указанный в spec.json, при написании или обновлении `research.md`

### Шаг 3: Сгенерировать документ дизайна

1. **Загрузить шаблон дизайна и правила**:
- Прочитать `{{KIRO_DIR}}/settings/templates/specs/ru/design.md` для структуры
- Прочитать `{{KIRO_DIR}}/settings/rules/design-principles.md` для принципов

2. **Сгенерировать документ дизайна**:
- **Строго следовать структуре шаблона specs/design.md и инструкциям генерации**
- **Интегрировать все результаты исследования**: Использовать исследованную информацию (API, паттерны, технологии) во всех определениях компонентов, архитектурных решениях и точках интеграции
- Если найден существующий design.md на Шаге 1, использовать как референс (режим слияния)
- Применять правила дизайна: Типобезопасность, Визуальная коммуникация, Формальный тон
- Использовать язык, указанный в spec.json
- Убедиться, что секции отражают обновлённые заголовки ("Architecture Pattern & Boundary Map", "Technology Stack & Alignment", "Components & Interface Contracts") и ссылаются на поддерживающие детали из `research.md`

3. **Обновить метаданные** в spec.json:
- Установить `phase: "design-generated"`
- Установить `approvals.design.generated: true, approved: false`
- Установить `approvals.requirements.approved: true`
- Обновить метку времени `updated_at`

## Критические ограничения
 - **Типобезопасность**:
   - Обеспечить строгую типизацию согласно стеку технологий проекта
   - Для статически типизированных языков определять явные типы/интерфейсы, избегать небезопасных приведений
   - Для TypeScript никогда не использовать `any`; предпочитать точные типы и дженерики
   - Для динамически типизированных языков использовать type hints/аннотации где доступно (например, Python type hints) и валидировать входные данные на границах
   - Документировать публичные интерфейсы и контракты чётко для обеспечения типобезопасности между компонентами
- **Актуальная информация**: Использовать WebSearch/WebFetch для внешних зависимостей и лучших практик
- **Согласование со Steering**: Уважать существующие архитектурные паттерны из контекста steering
- **Соответствие шаблону**: Строго следовать структуре шаблона specs/design.md и инструкциям генерации
- **Фокус на дизайне**: ТОЛЬКО архитектура и интерфейсы, без кода реализации
- **ID трассируемости требований**: Использовать только числовые ID требований (например, "1.1", "1.2", "3.1", "3.3") точно как определено в requirements.md. Не изобретать новые ID и не использовать буквенные метки
</instructions>

## Руководство по инструментам
- **Сначала читать**: Загрузить весь контекст перед действиями (спецификации, steering, шаблоны, правила)
- **Исследовать при неуверенности**: Использовать WebSearch/WebFetch для внешних зависимостей, API и последних лучших практик
- **Анализировать существующий код**: Использовать Grep для поиска паттернов и точек интеграции в кодовой базе
- **Писать в конце**: Генерировать design.md только после завершения всех исследований и анализа

## Описание вывода

**Вывод выполнения команды** (отдельно от содержимого design.md):

Предоставить краткую сводку на языке, указанном в spec.json:

1. **Статус**: Подтвердить генерацию документа дизайна в `{{KIRO_DIR}}/specs/$1/design.md`
2. **Тип исследования**: Какой процесс исследования был выполнен (полный/лёгкий/минимальный)
3. **Ключевые находки**: 2-3 критических инсайта из `research.md`, которые сформировали дизайн
4. **Следующее действие**: Руководство по workflow утверждения (см. Безопасность и Fallback)
5. **Лог исследований**: Подтвердить обновление `research.md` с последними решениями

**Формат**: Краткий Markdown (менее 200 слов) - это вывод команды, НЕ сам документ дизайна

**Примечание**: Фактический документ дизайна следует структуре `{{KIRO_DIR}}/settings/templates/specs/ru/design.md`.

## Безопасность и Fallback

### Сценарии ошибок

**Требования не утверждены**:
- **Остановить выполнение**: Нельзя продолжать без утверждённых требований
- **Сообщение пользователю**: "Требования ещё не утверждены. Утверждение требуется перед генерацией дизайна."
- **Предложенное действие**: "Запустите `/kiro:spec-design $1 -y` для авто-утверждения требований и продолжения"

**Отсутствуют требования**:
- **Остановить выполнение**: Документ требований должен существовать
- **Сообщение пользователю**: "requirements.md не найден в `{{KIRO_DIR}}/specs/$1/requirements.md`"
- **Предложенное действие**: "Запустите `/kiro:spec-requirements $1` для генерации требований сначала"

**Отсутствует шаблон**:
- **Сообщение пользователю**: "Файл шаблона отсутствует в `{{KIRO_DIR}}/settings/templates/specs/ru/design.md`"
- **Предложенное действие**: "Проверьте настройку репозитория или восстановите файл шаблона"
- **Fallback**: Использовать встроенную базовую структуру с предупреждением

**Отсутствует контекст Steering**:
- **Предупреждение**: "Каталог steering пустой или отсутствует - дизайн может не соответствовать стандартам проекта"
- **Продолжить**: Продолжить генерацию, но отметить ограничение в выводе

**Неясная сложность исследования**:
- **По умолчанию**: Использовать полный процесс исследования (`{{KIRO_DIR}}/settings/rules/design-discovery-full.md`)
- **Обоснование**: Лучше переисследовать, чем упустить критический контекст
- **Невалидные ID требований**:
  - **Остановить выполнение**: Если в requirements.md отсутствуют числовые ID или используются нечисловые заголовки (например, "Требование A"), остановить и попросить пользователя исправить requirements.md перед продолжением

### Следующая фаза: Генерация задач

**Если дизайн утверждён**:
- Просмотреть сгенерированный дизайн в `{{KIRO_DIR}}/specs/$1/design.md`
- **Опционально**: Запустить `/kiro:validate-design $1` для интерактивной проверки качества
- Затем `/kiro:spec-tasks $1 -y` для генерации задач реализации

**Если нужны изменения**:
- Предоставить обратную связь и повторно запустить `/kiro:spec-design $1`
- Существующий дизайн используется как референс (режим слияния)

**Примечание**: Утверждение дизайна обязательно перед переходом к генерации задач.

think hard
